// ===============================================
// PROFESSIONAL PUBG SCRIPT V2.0 (OPTIMIZED)
// Focus: Low Ping, Stability, Anti-Leak
// ===============================================

// ================= CONFIGURATION =================
var MATCH_PROXY = "PROXY 37.44.38.20:443";
var LOBBY_PROXIES = ["PROXY 2.59.53.74:443"]; // مصفوفة لإضافة أكثر من بروكسي مستقبلاً
var BLOCK = "PROXY 127.0.0.1:9";
var DIRECT = "DIRECT";

// ================= GEO-BLOCK (BLACKLIST) =================
// منع المناطق البعيدة ل_force_ اللعبة على اختيار أقرب سيرفر (ME)
// تم تحسين النطاقات لتكون أدق
var GEO_BLACKLIST = [
    // Europe (EU) - High Ping
    ["2.16.0.0", "255.248.0.0"], ["5.0.0.0", "255.0.0.0"], ["5.32.0.0", "255.224.0.0"],
    ["46.0.0.0", "255.0.0.0"], ["50.0.0.0", "255.0.0.0"], ["51.0.0.0", "255.0.0.0"],
    ["77.0.0.0", "255.0.0.0"], ["78.0.0.0", "255.0.0.0"], ["80.0.0.0", "255.0.0.0"],
    ["81.0.0.0", "255.0.0.0"], ["82.0.0.0", "255.0.0.0"], ["83.0.0.0", "255.0.0.0"],
    ["84.0.0.0", "255.0.0.0"], ["85.0.0.0", "255.0.0.0"], ["86.0.0.0", "255.0.0.0"],
    ["87.0.0.0", "255.0.0.0"], ["88.0.0.0", "255.0.0.0"], ["89.0.0.0", "255.0.0.0"],
    ["90.0.0.0", "255.0.0.0"], ["91.0.0.0", "255.0.0.0"], ["92.0.0.0", "255.0.0.0"],
    ["93.0.0.0", "255.0.0.0"], ["94.0.0.0", "255.0.0.0"], ["95.0.0.0", "255.0.0.0"],
    ["109.0.0.0", "255.0.0.0"], ["128.0.0.0", "255.0.0.0"], ["130.0.0.0", "255.0.0.0"],
    ["141.0.0.0", "255.0.0.0"], ["145.0.0.0", "255.0.0.0"], ["146.0.0.0", "255.0.0.0"],
    ["147.0.0.0", "255.0.0.0"], ["149.0.0.0", "255.0.0.0"], ["151.0.0.0", "255.0.0.0"],
    ["152.0.0.0", "255.0.0.0"], ["153.0.0.0", "255.0.0.0"], ["155.0.0.0", "255.0.0.0"],
    ["157.0.0.0", "255.0.0.0"], ["158.0.0.0", "255.0.0.0"], ["159.0.0.0", "255.0.0.0"],
    ["160.0.0.0", "255.0.0.0"], ["161.0.0.0", "255.0.0.0"], ["162.0.0.0", "255.0.0.0"],
    ["163.0.0.0", "255.0.0.0"], ["164.0.0.0", "255.0.0.0"], ["165.0.0.0", "255.0.0.0"],
    ["166.0.0.0", "255.0.0.0"], ["167.0.0.0", "255.0.0.0"], ["168.0.0.0", "255.0.0.0"],
    ["169.0.0.0", "255.0.0.0"], ["170.0.0.0", "255.0.0.0"], ["171.0.0.0", "255.0.0.0"],
    ["172.0.0.0", "255.0.0.0"], ["173.0.0.0", "255.0.0.0"], ["174.0.0.0", "255.0.0.0"],
    ["175.0.0.0", "255.0.0.0"], ["176.0.0.0", "255.0.0.0"], ["177.0.0.0", "255.0.0.0"],
    ["178.0.0.0", "255.0.0.0"], ["179.0.0.0", "255.0.0.0"], ["180.0.0.0", "255.0.0.0"],
    ["181.0.0.0", "255.0.0.0"], ["182.0.0.0", "255.0.0.0"], ["183.0.0.0", "255.0.0.0"],
    ["185.0.0.0", "255.0.0.0"], ["188.0.0.0", "255.0.0.0"], ["189.0.0.0", "255.0.0.0"],
    ["190.0.0.0", "255.0.0.0"], ["192.0.0.0", "255.0.0.0"], ["193.0.0.0", "255.0.0.0"],
    ["194.0.0.0", "255.0.0.0"], ["195.0.0.0", "255.0.0.0"], ["196.0.0.0", "255.0.0.0"],
    ["197.0.0.0", "255.0.0.0"], ["198.0.0.0", "255.0.0.0"], ["199.0.0.0", "255.0.0.0"],
    ["212.0.0.0", "255.0.0.0"], ["213.0.0.0", "255.0.0.0"], ["217.0.0.0", "255.0.0.0"],

    // Russia (RU) - Bad Routing
    ["5.136.0.0", "255.248.0.0"], ["31.128.0.0", "255.192.0.0"], ["45.128.0.0", "255.128.0.0"],
    ["46.16.0.0", "255.240.0.0"], ["77.88.0.0", "255.252.0.0"], ["81.9.0.0", "255.255.0.0"],
    ["84.201.0.0", "255.255.0.0"], ["87.250.0.0", "255.255.0.0"], ["90.156.0.0", "255.255.0.0"],
    ["93.158.0.0", "255.255.0.0"], ["95.24.0.0", "255.248.0.0"], ["109.235.0.0", "255.255.0.0"],
    ["178.64.0.0", "255.192.0.0"], ["185.32.0.0", "255.224.0.0"], ["213.180.0.0", "255.255.0.0"],

    // Asia (AS) - High Ping
    ["1.0.0.0", "255.0.0.0"], ["14.0.0.0", "255.0.0.0"], ["27.0.0.0", "255.0.0.0"],
    ["36.0.0.0", "255.0.0.0"], ["39.0.0.0", "255.0.0.0"], ["42.0.0.0", "255.0.0.0"],
    ["49.0.0.0", "255.0.0.0"], ["58.0.0.0", "255.0.0.0"], ["59.0.0.0", "255.0.0.0"],
    ["60.0.0.0", "255.0.0.0"], ["61.0.0.0", "255.0.0.0"], ["101.0.0.0", "255.0.0.0"],
    ["106.0.0.0", "255.0.0.0"], ["110.0.0.0", "255.0.0.0"], ["111.0.0.0", "255.0.0.0"],
    ["112.0.0.0", "255.0.0.0"], ["113.0.0.0", "255.0.0.0"], ["114.0.0.0", "255.0.0.0"],
    ["115.0.0.0", "255.0.0.0"], ["116.0.0.0", "255.0.0.0"], ["117.0.0.0", "255.0.0.0"],
    ["118.0.0.0", "255.0.0.0"], ["119.0.0.0", "255.0.0.0"], ["120.0.0.0", "255.0.0.0"],
    ["121.0.0.0", "255.0.0.0"], ["122.0.0.0", "255.0.0.0"], ["123.0.0.0", "255.0.0.0"],
    ["124.0.0.0", "255.0.0.0"], ["125.0.0.0", "255.0.0.0"], ["126.0.0.0", "255.0.0.0"],
    ["133.0.0.0", "255.0.0.0"], ["139.0.0.0", "255.0.0.0"], ["150.0.0.0", "255.0.0.0"],
    ["153.0.0.0", "255.0.0.0"], ["163.0.0.0", "255.0.0.0"], ["171.0.0.0", "255.0.0.0"],
    ["175.0.0.0", "255.0.0.0"], ["180.0.0.0", "255.0.0.0"], ["182.0.0.0", "255.0.0.0"],
    ["202.0.0.0", "255.0.0.0"], ["203.0.0.0", "255.0.0.0"], ["210.0.0.0", "255.0.0.0"],
    ["211.0.0.0", "255.0.0.0"], ["218.0.0.0", "255.0.0.0"], ["219.0.0.0", "255.0.0.0"],
    ["220.0.0.0", "255.0.0.0"], ["221.0.0.0", "255.0.0.0"], ["222.0.0.0", "255.0.0.0"],
    ["223.0.0.0", "255.0.0.0"]
];

// ================= GLOBAL STATE =================
var _Session = {
    ipCache: {},      // DNS Cache
    matchIP: null,    // تثبيت IP الماتش
    matchNet: null    // تثبيت شبكة الماتش
};

// ================= HELPERS (OPTIMIZED) =================
// دالة سريعة للتحقق من النصوص (بدون Regex لتقليل اللود)
function strContains(str, keywords) {
    if (!str) return false;
    str = str.toLowerCase();
    for (var i = 0; i < keywords.length; i++) {
        if (str.indexOf(keywords[i]) !== -1) return true;
    }
    return false;
}

// التحقق من القوائم السوداء (Optimized Loop)
function isGeoBlocked(ip) {
    for (var i = 0; i < GEO_BLACKLIST.length; i++) {
        if (isInNet(ip, GEO_BLACKLIST[i][0], GEO_BLACKLIST[i][1])) return true;
    }
    return false;
}

// جلب IP مع كاش (تقليل استهلاك الشبكة)
function getIp(host) {
    if (_Session.ipCache[host]) return _Session.ipCache[host];
    var ip = dnsResolve(host);
    if (ip) _Session.ipCache[host] = ip;
    return ip;
}

// اختيار بروكسي اللوبي
function getLobbyProxy(host) {
    // حالياً بروكسي واحد، يمكن تطويره لاحقاً
    return LOBBY_PROXIES[0]; 
}

// ================= MAIN LOGIC =================
function FindProxyForURL(url, host) {
    // 1. تنظيف الـ Host
    host = host.toLowerCase();
    var colon = host.indexOf(":");
    if (colon !== -1) host = host.substring(0, colon);

    // 2. فلترة سريعة: إذا مش PUBG، اخرج فوراً (Fast Path)
    // قائمة النطاقات الأساسية لتسريع الكشف
    if (!strContains(host, ["pubg", "tencent", "krafton", "levelinfinite", "lightspeed", "igame", "proximabeta", "gcloud", "anticheatexpert"])) {
        return DIRECT;
    }

    // 3. تحليل نوع الاتصال (Traffic Classification)
    var isGameMatch = strContains(url + host, ["match", "battle", "game", "combat", "room", "sync", "realtime", "umg", "ping"]);
    var isLobby = strContains(url + host, ["lobby", "dispatch", "gate", "queue", "account", "login", "auth", "ac"]);
    var isAsset = strContains(url + host, ["cdn", "asset", "patch", "update", "resource", "static", "os"];

    // 4. التعامل مع التحديثات والأصول (Assets/CDN)
    // الأفضل تكون DIRECT لتسريع التحميل، إلا إذا كان محجوباً
    if (isAsset) {
        return DIRECT; 
    }

    // 5. معالجة اللوبي (Lobby/Login)
    if (isLobby && !isGameMatch) {
        return getLobbyProxy(host);
    }

    // 6. معالجة الماتش (Game Match) - الجزء الأهم لثبات البنق
    if (isGameMatch) {
        var ip = getIp(host);
        
        // إذا لم يتم حل الـ IP، نعطي بروكسي الماتش ونحاول الحظ
        if (!ip) return MATCH_PROXY;

        // حجب المناطق البعيدة (Geo-Force)
        if (isGeoBlocked(ip)) {
            return BLOCK;
        }

        // منطق الثبات (Stability Logic)
        var net24 = ip.split('.').slice(0, 3).join('.');

        // إذا لم نكن في جلسة ماتش، سجل الجلسة الجديدة
        if (!_Session.matchNet) {
            _Session.matchNet = net24;
            _Session.matchIP = ip;
        }
        
        // إذا تغيرت الشبكة أثناء اللعب (نادراً ما يحدث)، يمكن إعادة التوجيه
        // لكن الأفضل تثبيت البروكسي لمنع كرش اللعبة
        
        return MATCH_PROXY;
    }

    // 7. الافتراضي: توجيه لبروكسي اللوبي
    return getLobbyProxy(host);
}
